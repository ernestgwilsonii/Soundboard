services:
  # The Main Application (Production-like)
  app:
    build:
      context: .
      target: production
    image: soundboard-app:latest
    ports:
      - "5000:8000"
    volumes:
      # Persist SQLite Databases
      - db_data:/app/data
      # Persist User Uploads (Audio/Images)
      - upload_data:/app/app/static/uploads
      # Uncomment the next line for "Hot Reloading" / Live Code Editing:
      # - .:/app
    environment:
      - ACCOUNTS_DB=/app/data/accounts.sqlite3
      - SOUNDBOARDS_DB=/app/data/soundboards.sqlite3
      - REDIS_URL=redis://redis:6379/0
      - USE_REDIS_QUEUE=true
      - SECRET_KEY=dev-secret-key-change-in-prod
      - MAIL_SERVER=mailpit
      - MAIL_PORT=1025
    depends_on:
      - redis
      - mailpit
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  mailpit:
    image: axllent/mailpit:latest
    restart: always
    ports:
      - "8025:8025" # Web UI
      - "1025:1025" # SMTP Port
    environment:
      - MP_MAX_MESSAGES=5000
      - MP_DATABASE=/data/mailpit.db
    volumes:
      - mailpit_data:/data

  # The Test Runner (Troubleshooting & Verification)
  # Run with: docker compose run --rm test
  test:
    build:
      context: .
      target: test
    image: soundboard-test:latest
    volumes:
      # Mount code so tests run against current local changes
      - .:/app
      # Use a temporary DB location or memory for tests (managed by conftest)
    environment:
      - TESTING=true
      - REDIS_URL=redis://redis:6379/0
      - USE_REDIS_QUEUE=false
      - MAIL_SERVER=mailpit
      - MAIL_PORT=1025
    depends_on:
      - redis
      - mailpit
    # Keep container alive if you want to exec into it, or just run pytest
    command: pytest

volumes:
  db_data:
  upload_data:
  redis_data:
  mailpit_data:
